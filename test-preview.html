<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders Table Preview - Shop.app Deliveries Extension</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        .mock-header {
            height: 60px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 24px;
        }
        .mock-header h3 {
            margin: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="mock-header">
        <h3>Shop.app Orders Preview (Test)</h3>
    </div>

    <div id="orders-content"></div>

    <script>
        // Mock data similar to what the API would return
        const mockData = {
            data: {
                deliveriesOrdersList: {
                    nodes: [
                        {
                            id: "order1",
                            orderNumber: "SHOP-2024-0001",
                            createdAt: "2024-01-15T10:30:00Z",
                            totalPrice: { amount: "49.99", currencyCode: "USD" },
                            shop: { id: "shop1", name: "TechGear Store" },
                            deliveryStatus: "in_transit",
                            shippingMethod: "Standard",
                            trackers: {
                                nodes: [{
                                    id: "track1",
                                    trackingUrl: "https://tracking.example.com/123456",
                                    carrierInfo: { name: "FedEx" }
                                }]
                            },
                            deliveries: {
                                nodes: [{
                                    id: "del1",
                                    name: "Wireless Mouse",
                                    status: "in_transit",
                                    state: "shipped",
                                    deliveredAt: null,
                                    originalEtaInfo: {
                                        formattedEta: "Jan 20, 2024",
                                        isFuture: true
                                    }
                                }]
                            }
                        },
                        {
                            id: "order2",
                            orderNumber: "SHOP-2024-0002",
                            createdAt: "2024-01-10T15:45:00Z",
                            totalPrice: { amount: "129.95", currencyCode: "USD" },
                            shop: { id: "shop2", name: "Fashion Hub" },
                            deliveryStatus: "delivered",
                            shippingMethod: "Express",
                            trackers: {
                                nodes: [{
                                    id: "track2",
                                    trackingUrl: "https://tracking.example.com/789012",
                                    carrierInfo: { name: "UPS" }
                                }]
                            },
                            deliveries: {
                                nodes: [
                                    {
                                        id: "del2",
                                        name: "Winter Jacket",
                                        status: "delivered",
                                        state: "delivered",
                                        deliveredAt: "2024-01-13T14:20:00Z",
                                        originalEtaInfo: {
                                            formattedEta: "Jan 13, 2024",
                                            isFuture: false
                                        }
                                    },
                                    {
                                        id: "del3",
                                        name: "Wool Scarf",
                                        status: "delivered",
                                        state: "delivered",
                                        deliveredAt: "2024-01-13T14:20:00Z",
                                        originalEtaInfo: {
                                            formattedEta: "Jan 13, 2024",
                                            isFuture: false
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            id: "order3",
                            orderNumber: "SHOP-2024-0003",
                            createdAt: "2024-01-18T09:00:00Z",
                            totalPrice: { amount: "25.00", currencyCode: "USD" },
                            shop: { id: "shop3", name: "Book World" },
                            deliveryStatus: "processing",
                            shippingMethod: "Economy",
                            trackers: { nodes: [] },
                            deliveries: { nodes: [] }
                        }
                    ],
                    pageInfo: {
                        hasNextPage: false,
                        endCursor: null
                    }
                }
            }
        };

        // Load the content script functions
        function createOrdersTable(data) {
            const container = document.createElement('div');
            container.className = 'orders-container';

            // Create header
            const header = document.createElement('div');
            header.className = 'orders-header';
            header.innerHTML = `
                <h1>Your Orders & Deliveries</h1>
                <button id="refresh-orders" class="refresh-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    Refresh
                </button>
            `;
            container.appendChild(header);

            // Process data into table rows
            const tableData = [];

            if (data.data?.deliveriesOrdersList?.nodes) {
                data.data.deliveriesOrdersList.nodes.forEach((order, i) => {
                    const trackers = order.trackers?.nodes || [];
                    const deliveries = order.deliveries?.nodes || [];

                    if (deliveries.length > 0) {
                        deliveries.forEach((delivery, j) => {
                            const tracker = trackers[j] || trackers[0];
                            tableData.push({
                                index: `${i + 1}.${j + 1}`,
                                orderNumber: order.orderNumber,
                                shop: order.shop?.name || 'N/A',
                                delivery: delivery.name || 'N/A',
                                status: delivery.status,
                                state: delivery.state,
                                carrier: tracker?.carrierInfo?.name || 'N/A',
                                trackingUrl: tracker?.trackingUrl || null,
                                eta: delivery.originalEtaInfo?.formattedEta || 'N/A',
                                isFuture: delivery.originalEtaInfo?.isFuture,
                                deliveredAt: delivery.deliveredAt,
                                total: `${order.totalPrice.amount} ${order.totalPrice.currencyCode}`,
                                createdAt: order.createdAt
                            });
                        });
                    } else {
                        const tracker = trackers[0];
                        tableData.push({
                            index: i + 1,
                            orderNumber: order.orderNumber,
                            shop: order.shop?.name || 'N/A',
                            delivery: 'No deliveries',
                            status: order.deliveryStatus || 'N/A',
                            state: 'N/A',
                            carrier: tracker?.carrierInfo?.name || 'N/A',
                            trackingUrl: tracker?.trackingUrl || null,
                            eta: 'N/A',
                            isFuture: null,
                            deliveredAt: null,
                            total: `${order.totalPrice.amount} ${order.totalPrice.currencyCode}`,
                            createdAt: order.createdAt
                        });
                    }
                });
            }

            // Create table
            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'table-wrapper';

            const table = document.createElement('table');
            table.className = 'orders-table';

            // Create table header
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>#</th>
                    <th>Order #</th>
                    <th>Shop</th>
                    <th>Item/Delivery</th>
                    <th>Status</th>
                    <th>State</th>
                    <th>Carrier</th>
                    <th>Tracking</th>
                    <th>ETA</th>
                    <th>Delivered</th>
                    <th>Total</th>
                </tr>
            `;
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');

            tableData.forEach(row => {
                const tr = document.createElement('tr');

                // Format delivered date
                let deliveredText = 'Not yet';
                if (row.deliveredAt) {
                    const date = new Date(row.deliveredAt);
                    deliveredText = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }

                // Format ETA
                let etaText = row.eta;
                if (row.isFuture !== null) {
                    etaText = `${row.eta} ${row.isFuture ? '(Future)' : '(Past)'}`;
                }

                // Create tracking link
                let trackingCell = 'No';
                if (row.trackingUrl) {
                    trackingCell = `<a href="${row.trackingUrl}" target="_blank" class="tracking-link">Track</a>`;
                }

                // Set status class
                let statusClass = 'status-pending';
                if (row.status === 'delivered' || row.state === 'delivered') {
                    statusClass = 'status-delivered';
                } else if (row.status === 'in_transit' || row.state === 'in_transit') {
                    statusClass = 'status-transit';
                }

                tr.innerHTML = `
                    <td>${row.index}</td>
                    <td class="order-number">${row.orderNumber}</td>
                    <td>${row.shop}</td>
                    <td>${row.delivery}</td>
                    <td><span class="status-badge ${statusClass}">${row.status}</span></td>
                    <td>${row.state}</td>
                    <td>${row.carrier}</td>
                    <td>${trackingCell}</td>
                    <td>${etaText}</td>
                    <td>${deliveredText}</td>
                    <td class="total">${row.total}</td>
                `;

                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            tableWrapper.appendChild(table);
            container.appendChild(tableWrapper);

            // Add summary section
            const summary = document.createElement('div');
            summary.className = 'orders-summary';

            const totalOrders = new Set(tableData.map(r => r.orderNumber)).size;
            const deliveredCount = tableData.filter(r => r.status === 'delivered' || r.state === 'delivered').length;
            const inTransitCount = tableData.filter(r => r.status === 'in_transit' || r.state === 'in_transit').length;

            summary.innerHTML = `
                <div class="summary-card">
                    <h3>Total Orders</h3>
                    <p>${totalOrders}</p>
                </div>
                <div class="summary-card">
                    <h3>Delivered</h3>
                    <p>${deliveredCount}</p>
                </div>
                <div class="summary-card">
                    <h3>In Transit</h3>
                    <p>${inTransitCount}</p>
                </div>
            `;

            container.appendChild(summary);

            return container;
        }

        // Display the mock data
        const contentArea = document.getElementById('orders-content');
        const ordersTable = createOrdersTable(mockData);
        contentArea.appendChild(ordersTable);

        // Add click handler for refresh button
        document.getElementById('refresh-orders').addEventListener('click', () => {
            alert('This is a test preview. The refresh button will work when installed on shop.app');
        });
    </script>
</body>
</html>